-- FLOW
DROP TABLE xdr_<<PROJECT_ID>>_flow_pre1 PURGE;
CREATE TABLE xdr_<<PROJECT_ID>>_flow_pre1 AS
SELECT DISTINCT t.pat_id
    ,t.ip_patient_id
    ,enc.pat_enc_csn_id
    ,enc.inpatient_data_id
    ,rec.fsd_id
FROM xdr_<<PROJECT_ID>>_<<LINK_TBL>>        t
join i2b2.lz_clarity_enc                    enc ON coh.<<LINK_COL>> = enc.<<LINK_COL>>
JOIN ip_flwsht_rec                          rec ON enc.inpatient_data_id = rec.inpatient_data_id
;

DROP TABLE xdr_<<PROJECT_ID>>_flow_pre2 PURGE;
CREATE TABLE xdr_<<PROJECT_ID>>_flow_pre2 AS
SELECT DISTINCT t.pat_id
    ,t.ip_patient_id
    ,t.pat_enc_csn_id
    ,meas.flt_id
    ,meas.flo_meas_id
    ,meas.recorded_time
    ,meas.meas_value measure_value
FROM xdr_<<PROJECT_ID>>_flow_pre1           t   
JOIN ip_flwsht_meas                         meas ON coh.fsd_id = meas.fsd_id
WHERE meas.recorded_time IS NOT NULL 
AND meas.meas_value IS NOT NULL
AND meas.flo_meas_id IN (
    '11'         --Height
    ,'14'         --Weight
    ,'5'          --Blood Pressure  
    ,'8'          --Pulse
    ,'6'          --Temperature
    ,'9'          --Respiratory Rate 
    ,'10'         --Pulse Oximetry (SpO2)
    ,'301030'     --Oxygen Device
    ,'301070'     --BMI
    ,'3040000947' --INTUBATION  
    ,'3040000940' --EXTUBATION 
    ,'3040090345' --INTUBATION WHEN meas.meas_value LIKE '%INTUBATION%' OR EXTUBATION WHEN meas.meas_value LIKE '%EXTUBATION%'
)
;

DROP TABLE xdr_<<PROJECT_ID>>_flow PURGE;
CREATE TABLE xdr_<<PROJECT_ID>>_flow AS
SELECT DISTINCT t.pat_id
    ,t.ip_patient_id
    ,t.pat_enc_csn_id
    ,t.flt_id
    ,t.flo_meas_id
    ,t.recorded_time            vital_sign_taken_time 
    ,t.measure_value            vital_sign_value
    ,dta.template_name
    ,dta.display_name
    ,gpd.disp_name              vital_sign_type
    ,gpd.flo_meas_name
FROM xdr_<<PROJECT_ID>>_flow_pre2       t   
JOIN ip_flo_gp_data                     gpd ON coh.flo_meas_id = gpd.flo_meas_id
JOIN ip_flt_data                        dta ON coh.flt_id = dta.template_id
; 
