-- PAT
DROP TABLE xdr_<<PROJECT_ID>>_pat PURGE;
CREATE TABLE xdr_<<PROJECT_ID>>_pat AS
SELECT DISTINCT pat.pat_id
    ,pat.pat_mrn_id
    ,pat.pat_mrn_id                                                 MRN
    ,'IPPAT_' || (bip.patient_num + (101101101 * <<PROJECT_ID>>))      ip_patient_id
    ,pat.birth_date                                                 DOB
    ,pat.ethnic_group                                               ETHNICITY
    ,pat.mapped_race_name                                           RACE
    ,pat.sex                                                        SEX
    ,pat.language                                                   LANGUAGE
    ,pat.marital_status                                             MARITAL_STATUS
    ,pat.religion                                                   RELIGION
    ,pat.sexual_orient                                              SEXUAL_ORIENTATION
    ,pat.cur_pcp_prov_id
    ,death.vital_status
    ,death.death_date
    ,case when death.vital_status = 'Known Deceased' and death.death_date is null then null 
        else floor(months_between(COALESCE(death.death_date, current_date), death.dob) / 12)
        end age
    ,geo.ADI_NATRANK
    ,geo.ADI_STATERNK
    ,geo.education_cd                                               EDUCATION
    ,geo.income_cd                                                  INCOME
    ,geo.Svi_Socio_Econ
    ,geo.SVI_HCOMP_LANG SVI_HCOMP
    ,geo.Svi_Mino_Lang
    ,geo.SVI_HTYP_TRANS SVI_HTYPE_TRANS
    ,geo.Svi_Total
    ,round(geo.rr_distance_mts / 1609, 2) distance_ucla_miles
    ,p2.pat_name
    ,p2.add_line_1 address_1
    ,p2.add_line_2 address_2
    ,p2.city
    ,pat.state
    ,pat.zip zip_code
    ,pc.home_phone
    ,pc.cell_phone
    ,pc.email_address email
FROM i2b2.lz_clarity_patient        pat
join patient p2 on pat.pat_id = p2.pat_id
left join i2b2.lz_clarity_pat_contacts pc on pc.pat_id = pat.pat_id
JOIN xdr_<<PROJECT_ID>>_coh         coh ON pat.pat_id = coh.pat_id
join i2b2.bip_patient_link          bip on bip.patient_ide = coh.pat_id
LEFT JOIN JSANZ.BIP_PAT_GEOCODE     geo ON pat.pat_id = geo.pat_id
join (
    select pat.pat_id
        ,case when pat.pat_status_c = 2 or enc.pat_id is not null or death.pat_id is not null then 'Known Deceased' else 'Not Known Deceased' end vital_status
        ,COALESCE(pat.death_date, max(enc.hosp_disch_time) over (partition by enc.pat_id), death.death_date) death_date
        ,pat.birth_date dob
    from xdr_<<PROJECT_ID>>_coh coh 
    join patient pat on coh.pat_id = pat.pat_id
    left join pat_enc_hsp enc on pat.pat_id = enc.pat_id and (enc.disch_disp_c in ('20', '40', '41', '42', '71') or enc.ed_disposition_c = '8')
    left join i2b2.lz_death death on pat.pat_id = death.pat_id
) death on coh.pat_id = death.pat_id
;