-- LAB
DROP TABLE xdr_<<PROJECT_ID>>_lab PURGE;
CREATE TABLE xdr_<<PROJECT_ID>>_lab AS 
SELECT DISTINCT t.pat_id
    ,t.pat_mrn_id
    ,t.ip_patient_id
    ,lab.pat_enc_csn_id      
    ,lab.order_proc_id
    ,lab.order_time
    ,lab.result_time
    ,lab.specimn_taken_time 
    ,lab.proc_id
    ,lab.proc_code
    ,lab.description
    ,lab.component_id
    ,lab.component_name
    ,lab.ord_value
    ,lab.reference_unit 
FROM xdr_<<PROJECT_ID>>_<<LINK_TBL>>        t
JOIN i2b2.lz_clarity_labs                   lab ON t.<<LINK_COL>> = lab.<<LINK_COL>>
;

drop table xdr_<<PROJECT_ID>>_lab_ipid purge;
create table xdr_<<PROJECT_ID>>_lab_ipid as
select order_proc_id
    ,i2b2.f_get_deid_new(4, order_proc_id, <<PROJECT_ID>>)  ip_order_proc_id
from (
    select distinct order_proc_id 
    from xdr_<<PROJECT_ID>>_lab
)
;